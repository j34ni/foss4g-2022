
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Parallel computing with Dask &#8212; Pangeo Tutorial at FOSS4G 2022</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Resources" href="../afterword/resources.html" />
    <link rel="prev" title="Data chunking and compression" href="chunking_introduction.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/pangeo_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Pangeo Tutorial at FOSS4G 2022</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome 👋
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  About
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../about/timeline.html">
   Workshop timeline
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Before the workshop
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../before/setup.html">
   Setup: how to run the tutorial
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Pangeo 101
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="xarray_introduction.html">
   Handling multi-dimensional arrays with xarray
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="visualization.html">
   Interactive plotting with holoviews
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_discovery.html">
   Data access and discovery
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chunking_introduction.html">
   Chunking and compression
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Parallel computing with dask
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Beyond the workshop
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../afterword/resources.html">
   Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../afterword/pythia.html">
   Project Pythia
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../afterword/envds-book.html">
   Environmental Data Science Book
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://notebooks.gesis.org/binder/v2/gh/pangeo-data/foss4g-2022/main?urlpath=tree/tutorial/pangeo101/dask_introduction.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://pangeo-foss4g.vm.fedcloud.eu/jupyterhub/hub/user-redirect/git-pull?repo=https%3A//github.com/pangeo-data/foss4g-2022&urlpath=tree/foss4g-2022/tutorial/pangeo101/dask_introduction.ipynb&branch=main"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on JupyterHub"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="headerbtn__text-container">JupyterHub</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/pangeo-data/foss4g-2022"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/pangeo-data/foss4g-2022/issues/new?title=Issue%20on%20page%20%2Fpangeo101/dask_introduction.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/pangeo101/dask_introduction.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#authors-contributors">
   Authors &amp; Contributors
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#authors">
     Authors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contributors">
     Contributors
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#context">
   Context
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data">
     Data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#packages">
     Packages
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelize-with-dask">
   Parallelize with Dask
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-is-dask">
     What is Dask?
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-does-dask-accelerate-your-data-analysis">
       How does Dask accelerate your data analysis?
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-does-xarray-with-dask-distribute-data-analysis">
       How does Xarray with dask distribute data analysis?
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up-dask-gateway">
   Set up Dask Gateway
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-a-new-cluster">
   Create a new cluster
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-a-client-from-the-dask-gateway-cluster">
   Get a client from the Dask Gateway Cluster
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#open-a-single-file-for-parallel-processing">
   Open a single file for parallel processing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#select-a-single-location-and-visualize-the-task-graph">
   Select a single location and visualize the task graph
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimize-the-task-graph">
   Optimize the task graph
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#install-missing-packages-on-the-dask-workers">
   Install missing packages on the dask workers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute-on-the-dask-workers">
   Compute on the dask workers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#global-lts">
   Global LTS
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-from-online-kerchunked-consolidated-dataset">
   Read from online kerchunked consolidated dataset
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fix-time-coordinate">
     Fix time coordinate
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clip-lts-over-lombardia">
   Clip LTS over Lombardia
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#print-metadata">
     Print metadata
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute">
   Compute
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-additional-packages-in-dask-workers">
     Install additional packages in dask workers
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-ndvi-for-2022-over-lombardia">
   Get NDVI for 2022 over Lombardia
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Parallel computing with Dask</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#authors-contributors">
   Authors &amp; Contributors
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#authors">
     Authors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#contributors">
     Contributors
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#context">
   Context
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data">
     Data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#packages">
     Packages
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelize-with-dask">
   Parallelize with Dask
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-is-dask">
     What is Dask?
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-does-dask-accelerate-your-data-analysis">
       How does Dask accelerate your data analysis?
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-does-xarray-with-dask-distribute-data-analysis">
       How does Xarray with dask distribute data analysis?
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up-dask-gateway">
   Set up Dask Gateway
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-a-new-cluster">
   Create a new cluster
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-a-client-from-the-dask-gateway-cluster">
   Get a client from the Dask Gateway Cluster
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#open-a-single-file-for-parallel-processing">
   Open a single file for parallel processing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#select-a-single-location-and-visualize-the-task-graph">
   Select a single location and visualize the task graph
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimize-the-task-graph">
   Optimize the task graph
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#install-missing-packages-on-the-dask-workers">
   Install missing packages on the dask workers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute-on-the-dask-workers">
   Compute on the dask workers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#global-lts">
   Global LTS
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-from-online-kerchunked-consolidated-dataset">
   Read from online kerchunked consolidated dataset
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fix-time-coordinate">
     Fix time coordinate
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clip-lts-over-lombardia">
   Clip LTS over Lombardia
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#print-metadata">
     Print metadata
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute">
   Compute
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-additional-packages-in-dask-workers">
     Install additional packages in dask workers
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-ndvi-for-2022-over-lombardia">
   Get NDVI for 2022 over Lombardia
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="parallel-computing-with-dask">
<h1>Parallel computing with Dask<a class="headerlink" href="#parallel-computing-with-dask" title="Permalink to this headline">#</a></h1>
<section id="authors-contributors">
<h2>Authors &amp; Contributors<a class="headerlink" href="#authors-contributors" title="Permalink to this headline">#</a></h2>
<section id="authors">
<h3>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Tina Odaka, Ifremer (France), <a class="reference external" href="https://github.com/tinaok">&#64;tinaok</a></p></li>
</ul>
</section>
<section id="contributors">
<h3>Contributors<a class="headerlink" href="#contributors" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Pier Lorenzo Marasco, Ispra (Italy), <a class="reference external" href="https://github.com/pl-marasco">&#64;pl-marasco</a></p></li>
</ul>
<div class="alert alert-info">
<i class="fa-question-circle fa" style="font-size: 22px;color:#666;"></i> Overview
    <br>
    <br>
    <b>Questions</b>
    <ul>
        <li>What is Dask?</li>
        <li>How can I parallelize my data analysis with Dask?</li>
    </ul>
    <b>Objectives</b>
    <ul>
        <li>Learn about Dask</li>
        <li>Learn about Dask Gateway, Dask client, scheduler, workers</li>
        <li>Understand out-of-core and speed-up limitations</li>
    </ul>
</div></section>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">#</a></h2>
<p>We will be using <a class="reference external" href="https://docs.dask.org/">Dask</a> with <a class="reference external" href="https://docs.xarray.dev/en/stable/">Xarray</a> to parallelize our data analysis. The analysis is very similar to what we have done in previous episodes but this time we will use data on a global coverage that we read from a shared catalog (stored online in the Pangeo EOSC Openstack Object Storage).</p>
<section id="data">
<h3>Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h3>
<p>In this episode, we will be using Global Long Term Statistics (1999-2019) product provided by the <a class="reference external" href="https://land.copernicus.eu/global/index.html">Copernicus Global Land Service over Lombardia</a> and access them through <a class="reference external" href="https://en.wikipedia.org/wiki/Amazon_S3">S3-comptabile storage</a> (<a class="reference external" href="https://wiki.openstack.org/wiki/Swift">OpenStack Object Storage “Swift”</a>) with a data catalog we have created and made publicly available.</p>
</section>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h2>
<p>This episode uses the following Python packages:</p>
<ul class="simple">
<li><p>pooch</p></li>
<li><p>s3fs</p></li>
<li><p>xarray</p></li>
<li><p>netcdf4</p></li>
<li><p>h5netcdf</p></li>
<li><p>hvplot</p></li>
<li><p>dask</p></li>
<li><p>graphviz</p></li>
<li><p>numpy</p></li>
<li><p>pandas</p></li>
<li><p>geopandas</p></li>
</ul>
<p>Please install these packages if not already available in your Python environment (you might want to take a look at <a class="reference external" href="https://pangeo-data.github.io/foss4g-2022/before/setup.html">the Setup page of the tutorial</a>). Below, we only install packages that are not available in the EGI-ACE EOSC deployment of Pangeo for the FOSS4G course.</p>
<section id="packages">
<h3>Packages<a class="headerlink" href="#packages" title="Permalink to this headline">#</a></h3>
<p>In this episode, Python packages are imported when we start to use them. However, for best software practices, we recommend you to install and import all the necessary libraries at the top of your Jupyter notebook.</p>
</section>
</section>
<section id="parallelize-with-dask">
<h2>Parallelize with Dask<a class="headerlink" href="#parallelize-with-dask" title="Permalink to this headline">#</a></h2>
<p>We know that chunking is key for analyzing large datasets and in this episode, we will learn to parallelize our data analysis using Dask thanks to this chunking.</p>
<section id="what-is-dask">
<h3>What is Dask?<a class="headerlink" href="#what-is-dask" title="Permalink to this headline">#</a></h3>
<p><strong>Dask</strong> accelerates the existing Python ecosystem: with very or no changes in your code, you can speed-up computation using Dask.</p>
<ul class="simple">
<li><p>Dask is a flexible library for parallel computing in Python.</p></li>
<li><p>It is widely used for getting the necessary performance when handling large and complex Earth Science datasets.</p></li>
<li><p>Dask is powerful, scalable and flexible. It is the leading platform today for analytics.</p></li>
<li><p>It scales natively to clusters, cloud and bridges prototyping up to production.</p></li>
<li><p>The strength of Dask is that is accelerates the existing Python ecosystem e.g. Numpy, Pandas and Scikit-learn with few effort from end-users.</p></li>
</ul>
<p>It is interesting to note that at first, Dask has been created to handle data that is larger than memory, on a single computer. It then was extended with Distributed to compute data in parallel over cluster of computers.</p>
<section id="how-does-dask-accelerate-your-data-analysis">
<h4>How does Dask accelerate your data analysis?<a class="headerlink" href="#how-does-dask-accelerate-your-data-analysis" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>Dask chunks your big datasets and this is how we can easily parallelize and scale.</p></li>
</ul>
<p>For instance, dask can chunk a large numpy array into smaller ones and compute each chunk independently.</p>
<p><img alt="Dask and Numpy" src="https://examples.dask.org/_images/dask-array-black-text.svg" /></p>
<p><code class="docutils literal notranslate"><span class="pre">Xarray</span></code> uses Dask Arrays instead of Numpy when chunking is enabled, and thus all Xarray operations are distributed through Dask.</p>
</section>
<section id="how-does-xarray-with-dask-distribute-data-analysis">
<h4>How does Xarray with dask distribute data analysis?<a class="headerlink" href="#how-does-xarray-with-dask-distribute-data-analysis" title="Permalink to this headline">#</a></h4>
<p>When we use chunks with <code class="docutils literal notranslate"><span class="pre">Xarray</span></code>, the real computation is only done when needed; for instance when invoking <code class="docutils literal notranslate"><span class="pre">compute()</span></code> function. Dask generates a <strong>task graph</strong> describing the computation to be done and a <strong>scheduler</strong> executes these tasks across several <strong>workers</strong>.</p>
<p><img alt="Xarray with dask" src="../_images/dask-xarray-explained.png" /></p>
</section>
</section>
</section>
<section id="set-up-dask-gateway">
<h2>Set up Dask Gateway<a class="headerlink" href="#set-up-dask-gateway" title="Permalink to this headline">#</a></h2>
<p>There are different ways to use Dask depending on the underlying infrastructure. In the Pangeo EOSC you are using for this workshop, we have the possibility to set up Dask gateways to manage Dask clusters and run our data analysis in parallel e.g. distribute tasks across several workers.</p>
<p>If your on your own computer, you’ll prefer to use LocalCluster or the Client shortcut.</p>
<div class="cell tag_skip-execution docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask_gateway</span> <span class="kn">import</span> <span class="n">Gateway</span><span class="p">,</span> <span class="n">BasicAuth</span>
<span class="n">gateway</span> <span class="o">=</span> <span class="n">Gateway</span><span class="p">(</span>
    <span class="s2">&quot;http://api-daskhub-dask-gateway.daskhub:8000/&quot;</span><span class="p">,</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">BasicAuth</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="s2">&quot;pangeo_dask&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-new-cluster">
<h2>Create a new cluster<a class="headerlink" href="#create-a-new-cluster" title="Permalink to this headline">#</a></h2>
<div class="cell tag_skip-execution docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span> <span class="o">=</span> <span class="n">gateway</span><span class="o">.</span><span class="n">new_cluster</span><span class="p">()</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">cluster</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-a-client-from-the-dask-gateway-cluster">
<h2>Get a client from the Dask Gateway Cluster<a class="headerlink" href="#get-a-client-from-the-dask-gateway-cluster" title="Permalink to this headline">#</a></h2>
<p>The Dask client is what allows you to interact with Dask.
The Client will create the Directed Acyclic Graph (DAG) of tasks by analysing the code, and will be responsible for telling the scheduler what to compute. It will also gather results from the workers and aggregates the results in the Client process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">distributed</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="k">if</span> <span class="n">cluster</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="c1"># create a dask Gateway cluster</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>   <span class="c1"># create a local dask cluster on the machine.</span>
<span class="n">client</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [1],</span> in <span class="ni">&lt;cell line: 3&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="k">if</span> <span class="n">cluster</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="c1"># create a dask Gateway cluster</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="k">else</span><span class="p">:</span>

<span class="ne">NameError</span>: name &#39;cluster&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>A Dask client can also be created on a single machine (for instance your laptop) e.g. there is no need to have dedicated computational resources. However, speedup will only be limited to your single machine resources if you do not have dedicated computational resources!</p>
</div>
</section>
<section id="open-a-single-file-for-parallel-processing">
<h2>Open a single file for parallel processing<a class="headerlink" href="#open-a-single-file-for-parallel-processing" title="Permalink to this headline">#</a></h2>
<p>We will first open a single file: we use the same syntax as earlier but this time, we pass the additional parameter <code class="docutils literal notranslate"><span class="pre">chunks</span></code> to explicitely define how the chunking (and then parallel computing) needs to be done.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-1</span></code> for time means the dataset is loaded with dask using a single chunk for all arrays;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">auto</span></code> will use dask auto chunking taking into account the engine preferred chunks</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">s3fs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">client_kwargs</span><span class="o">=</span><span class="p">{</span>
         <span class="s1">&#39;endpoint_url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://object-store.cloud.muni.cz&#39;</span>
      <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">s3path</span> <span class="o">=</span> <span class="s1">&#39;s3://foss4g-data/CGLS_LTS_1999_2019/c_gls_NDVI-LTS_1999-2019-1221_GLOBE_VGT-PROBAV_V3.0.1.nc&#39;</span>
<span class="n">LTS</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s3path</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span><span class="mi">5000</span><span class="p">})</span>
<span class="n">LTS</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="select-a-single-location-and-visualize-the-task-graph">
<h2>Select a single location and visualize the task graph<a class="headerlink" href="#select-a-single-location-and-visualize-the-task-graph" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save</span><span class="o">=</span><span class="n">LTS</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">45.50</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">9.36</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
<span class="n">save</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>If you look to the task graph, you can see that only one dask worker needs to read the data (only one chunk needs to be read). So most dask workers are doing some useless reads of data.
We optimise, and verify the graph (as Dask is lazy, this is done automatically for you when you want to compute the result: Dask won’t load all data in memory if it does not need to).</p>
</section>
<section id="optimize-the-task-graph">
<h2>Optimize the task graph<a class="headerlink" href="#optimize-the-task-graph" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">save</span><span class="p">,)</span><span class="o">=</span><span class="n">dask</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
<span class="n">save</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="install-missing-packages-on-the-dask-workers">
<h2>Install missing packages on the dask workers<a class="headerlink" href="#install-missing-packages-on-the-dask-workers" title="Permalink to this headline">#</a></h2>
<p>The workers have their own conda environment, independent from what we have in our notebook. Most of the time, the workers do not have many Python packages installed by default (this is often not needed). Therefore, to be able to compute anything, we need to make sure the packages needed for the corresponding computation are available on the worker of the dask cluster. If not, using <code class="docutils literal notranslate"><span class="pre">.compute()</span></code> will fail.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">distributed.diagnostics.plugin</span> <span class="kn">import</span> <span class="n">PipInstall</span>

<span class="n">extra_packages</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xarray&quot;</span><span class="p">,</span> <span class="s2">&quot;netCDF4&quot;</span><span class="p">,</span> <span class="s2">&quot;s3fs&quot;</span><span class="p">,</span> <span class="s2">&quot;h5netcdf&quot;</span><span class="p">,</span> <span class="s2">&quot;zarr&quot;</span><span class="p">]</span>

<span class="n">plugin</span><span class="o">=</span><span class="n">PipInstall</span><span class="p">(</span><span class="n">extra_packages</span><span class="p">,</span><span class="n">restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">register_worker_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Verify the installation of package on dask worker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">get_versions</span><span class="p">(</span><span class="n">packages</span><span class="o">=</span><span class="n">extra_packages</span><span class="p">,</span><span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compute-on-the-dask-workers">
<h2>Compute on the dask workers<a class="headerlink" href="#compute-on-the-dask-workers" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="global-lts">
<h2>Global LTS<a class="headerlink" href="#global-lts" title="Permalink to this headline">#</a></h2>
<p>In the previous episode, we used Long-term Timeseries for the region of Lombardy e.g. a very small area. Now we would like to use the original dataset that has a global coverage.</p>
</section>
<section id="read-from-online-kerchunked-consolidated-dataset">
<h2>Read from online kerchunked consolidated dataset<a class="headerlink" href="#read-from-online-kerchunked-consolidated-dataset" title="Permalink to this headline">#</a></h2>
<p>The kerchunk generated Json file representing our dataset can be shared on cloud and loaded from there too. We will access Long Term TimeSeries of NDVI statistics from OpenStack Object Storage using the Zarr metadata generated with kerchunk (see previous episode on chunking).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">catalogue</span><span class="o">=</span><span class="s2">&quot;https://object-store.cloud.muni.cz/swift/v1/foss4g-catalogue/c_gls_NDVI-LTS_1999-2019.json&quot;</span>
<span class="n">LTS</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span>
    <span class="s2">&quot;reference://&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;zarr&quot;</span><span class="p">,</span>
    <span class="n">backend_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;storage_options&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;fo&quot;</span><span class="p">:</span><span class="n">catalogue</span>
                    <span class="p">},</span>
        <span class="s2">&quot;consolidated&quot;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">LTS</span>
</pre></div>
</div>
</div>
</div>
<section id="fix-time-coordinate">
<h3>Fix time coordinate<a class="headerlink" href="#fix-time-coordinate" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_2022</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;20220101&#39;</span><span class="p">,</span> <span class="s1">&#39;20221231&#39;</span><span class="p">)</span>
<span class="n">decadie</span> <span class="o">=</span> <span class="n">dates_2022</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dates_2022</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">21</span><span class="p">])]</span>
<span class="n">LTS</span> <span class="o">=</span> <span class="n">LTS</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">decadie</span><span class="p">)</span>
<span class="n">LTS</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="clip-lts-over-lombardia">
<h2>Clip LTS over Lombardia<a class="headerlink" href="#clip-lts-over-lombardia" title="Permalink to this headline">#</a></h2>
<p>As in previous episodes, we use a shapefile over Italy to select data over this Area of Interest (AOI).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">GAUL</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;Italy.geojson&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">GAUL</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;zip+https://mars.jrc.ec.europa.eu/asap/files/gaul1_asap.zip&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">AOI_name</span> <span class="o">=</span> <span class="s1">&#39;Lombardia&#39;</span>
<span class="n">AOI</span> <span class="o">=</span> <span class="n">GAUL</span><span class="p">[</span><span class="n">GAUL</span><span class="o">.</span><span class="n">name1</span> <span class="o">==</span> <span class="n">AOI_name</span><span class="p">]</span>
<span class="n">AOI_poly</span> <span class="o">=</span> <span class="n">AOI</span><span class="o">.</span><span class="n">geometry</span>
<span class="n">AOI_poly</span>
</pre></div>
</div>
</div>
</div>
<p>We first select a geographical area that covers Lombardia and then clip using the shapefile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LTS</span> <span class="o">=</span> <span class="n">LTS</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">46.5</span><span class="p">,</span><span class="mf">44.5</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">8.5</span><span class="p">,</span><span class="mf">11.5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LTS</span> <span class="o">=</span> <span class="n">LTS</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LTS</span> <span class="o">=</span> <span class="n">LTS</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">AOI_poly</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="print-metadata">
<h3>Print metadata<a class="headerlink" href="#print-metadata" title="Permalink to this headline">#</a></h3>
<p>We can print metadata without performing any computation yet. This is what we call <em>lazy</em> computation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LTS</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="compute">
<h2>Compute<a class="headerlink" href="#compute" title="Permalink to this headline">#</a></h2>
<section id="install-additional-packages-in-dask-workers">
<h3>Install additional packages in dask workers<a class="headerlink" href="#install-additional-packages-in-dask-workers" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extra_packages</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xarray&quot;</span><span class="p">,</span> <span class="s2">&quot;netCDF4&quot;</span><span class="p">,</span> <span class="s2">&quot;s3fs&quot;</span><span class="p">,</span> <span class="s2">&quot;h5netcdf&quot;</span><span class="p">,</span> <span class="s2">&quot;numpy&quot;</span><span class="p">,</span> <span class="s2">&quot;zip&quot;</span><span class="p">,</span> <span class="s2">&quot;pandas&quot;</span><span class="p">,</span> <span class="s2">&quot;geopandas&quot;</span><span class="p">,</span> <span class="s2">&quot;rioxarray&quot;</span><span class="p">,</span> <span class="s2">&quot;rasterio&quot;</span><span class="p">,</span> <span class="s2">&quot;scipy&quot;</span><span class="p">,</span> <span class="s2">&quot;zarr&quot;</span><span class="p">]</span>

<span class="n">plugin</span><span class="o">=</span><span class="n">PipInstall</span><span class="p">(</span><span class="n">extra_packages</span><span class="p">,</span><span class="n">restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">register_worker_plugin</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">LTS_min</span> <span class="o">=</span> <span class="n">LTS</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
<span class="p">(</span><span class="n">LTS_min</span><span class="p">,)</span><span class="o">=</span><span class="n">dask</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">LTS_min</span><span class="p">)</span>
<span class="n">LTS_min</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">LTS_min</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">LTS_max</span> <span class="o">=</span> <span class="n">LTS</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>
<span class="p">(</span><span class="n">LTS_max</span><span class="p">,)</span><span class="o">=</span><span class="n">dask</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">LTS_max</span><span class="p">)</span>
<span class="n">LTS_max</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">LTS_max</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="get-ndvi-for-2022-over-lombardia">
<h2>Get NDVI for 2022 over Lombardia<a class="headerlink" href="#get-ndvi-for-2022-over-lombardia" title="Permalink to this headline">#</a></h2>
<p>We re-use the file we created during the first episode. If the file is missing it will be downloaded from Zenodo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pooch</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">cgls_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;C_GLS_NDVI_20220101_20220701_Lombardia_S3_2_masked.nc&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">cgls_file</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://zenodo.org/record/6969999/files/C_GLS_NDVI_20220101_20220701_Lombardia_S3_2_masked.nc&quot;</span><span class="p">,</span>
        <span class="n">known_hash</span><span class="o">=</span><span class="s2">&quot;md5:be3f16913ebbdb4e7af227f971007b22&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;.&quot;</span><span class="p">,)</span>    
    <span class="n">cgls_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">cgls_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgls_ds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NDVI_AOI</span> <span class="o">=</span> <span class="n">cgls_ds</span><span class="o">.</span><span class="n">NDVI</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NDVI_AOI</span> <span class="o">=</span> <span class="n">NDVI_AOI</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">AOI_poly</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NDVI_AOI</span>
</pre></div>
</div>
</div>
</div>
<p>The nominal spatial resolution of the Long term statistics is 1km. As the current NDVI product has a nominal spatial resolution of 300m a re projection is needed. RioXarray through RasterIO that wraps the GDAL method can take care of this. More info about all the options can be found <a class="reference external" href="https://rasterio.readthedocs.io/en/stable/api/rasterio.warp.html#rasterio.warp.reproject">here</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NDVI_1k</span> <span class="o">=</span> <span class="n">NDVI_AOI</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">LTS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NDVI_1k</span> <span class="o">=</span> <span class="n">NDVI_1k</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="s1">&#39;lat&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VCI</span> <span class="o">=</span> <span class="p">((</span><span class="n">NDVI_1k</span> <span class="o">-</span> <span class="n">LTS</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">LTS</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">LTS</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VCI</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VCI</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;VCI&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VCI</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">VCI_c</span> <span class="o">=</span> <span class="n">VCI</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VCI</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now you have catalogue, original data source, both on cloud space, thus even from daks workers which does not have access to your NFS local disk space, datas are accessible.
Now you are ready to parallelize your analysis using dask workers from dask gateway!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-success">
    <i class="fa-check-circle fa" style="font-size: 22px;color:#666;"></i> <b>Key Points</b>
    <br>
    <ul>
        <li>Chunking and compression</li>
        <li>Dask</li>
    </ul>
</div></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./pangeo101"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="chunking_introduction.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Data chunking and compression</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../afterword/resources.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Resources</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Pangeo<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>